<!DOCTYPE html>
<html>
<!--
// OoLibrary Copyright (c) wanu@nyagoya
// Released under the MIT license http://opensource.org/licenses/mit-license.php
-->

<head>
  <meta charset="utf-8">
  <title>oo Scramble Images</title>
</head>

<body>
  <div>
    <input type="file" id="file" multiple="multiple" accept="image/*">
  </div>
  <br>
  <div>
    <textarea id="list" style="width:300px;height:10em" placeholder="選択されたファイル" readonly></textarea>
  </div>
  <br>
  <div>
    <button id="clear">クリア</button>
  </div>
  <br>

  <form id="ope_type">
    <input type="radio" name="ope_type" value="enc" checked>スクランブル
    <input type="radio" name="ope_type" value="dec">スクランブル解除
  </form>
  <br>

  <div>
    <label>暗号化キー</label>
    <input type="text" id="key" style="width:200px;">
  </div>
  <br>

  <div>
    <button id="save_png">PNGで保存</button>
  </div>
  <br>
  <div>
    <button id="save_jpg">JPGで保存</button>
    <label>画質</label>
    <input type="number" id="quality" style="width:50px;">
    <label>0.0 ～ 1.0 デフォルトは0.92</label>
  </div>
  <br>

  <div>
    <canvas id="canvas"></canvas>
  </div>

  <script src="../js/concat/oo.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const images = [];

      // キャンバス更新
      var update = function () {
        var total_width = 0;
        var max_height = 0;
        for (var img of images) {
          total_width += img.width;
          max_height = Math.max(max_height, img.height);
        }
        // 描画スケールを求める
        var cw = Math.min(total_width, window.innerWidth);
        var s = cw / total_width;
        // キャンバスサイズを変更
        canvas.width = cw;
        canvas.height = max_height * s;
        // 画像を描画
        var ctx = canvas.getContext('2d');
        var x = 0;
        for (var img of images) {
          ctx.drawImage(img, x, 0, img.width * s, img.height * s);
          x += img.width * s;
        }
      };

      // 画像のロード
      var loadFileListener = (e) => {
        for (var file of e.target.files) {
          var image = new Image();
          images.push(image);
          var reader = new FileReader();
          image.filename = file.name;
          image.reader = reader;
          image.onload = () => { update(); };
          reader.p_obj = image;
          reader.onload = function () {
            this.p_obj.src = this.result;
          };
          reader.readAsDataURL(file);
        }
      };

      // クリア
      const button_clear = document.getElementById("clear");
      button_clear.onclick = function () {
        document.getElementById("load").value = '';
        images.length = 0;
        update();
      };

      const getNonExtension = function (filename) {
        var pos = filename.lastIndexOf('.');
        if (pos < 0) return filename;
        return filename.substr(0, pos);
      };

      var getValueF = function (name, default_value) {
        var v = document.getElementById(name).value;
        var f = Number.parseFloat(v);
        if (!Number.isFinite(f)) f = default_value;
        return f;
      };

      var getValueI = function (name, default_value) {
        var v = document.getElementById(name).value;
        var i = Number.parseInt(v);
        if (!Number.isInteger(i)) i = default_value;
        return i;
      };

      // ext 'jpg' || ' png'
      var saveCanvasImage = function (canvas_name, file_name, ext, quality) {
        var canvas = document.getElementById(canvas_name);
        var link = document.createElement('a');
        if (ext === 'jpg') link.href = canvas.toDataURL('image/jpeg', quality);
        if (ext === 'png') link.href = canvas.toDataURL('image/png');
        link.download = file_name + '.' + ext;
        link.click();
      };

      // 変換テーブル
      var table = {};
      table.to = []; // 0 - (nx * ny - 1)
      table.op = []; // 0 - 7
  
      var drawScrambleImage = function (ctx, img, table) {

      }

      var scrambleImages = function (images, type) {
        var key = document.getElementById("key").value;
        var ope_type = document.getElementById("ope_type").ope_type.value;
        var q = getValueF('quality', 0.92);
        oo.serial(function* (proceeder) {
          for (var img of images) {
            var w = Math.ceil(img.width / 16);
            var h = Math.ceil(height / 16);


            var canvas = document.getElementById('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            saveCanvasImage('canvas', getNonExtension(img.filename), type, q);
            yield setTimeout(proceeder, 100);
          }
        }, null);
      };

      // png書き出し
      document.getElementById("save_png").onclick = function () {
        scrambleImages(images, 'png');
      };
      // jpg書き出し
      document.getElementById("save_jpg").onclick = function () {
        scrambleImages(images, 'jpg');
      };
      // 画像選択ボタンのイベントリスナー登録
      document.getElementById("file").addEventListener('change', loadFileListener, false);
    }, false);
  </script>

</body>

</html>